services:
  # PostgreSQL Veritabanı Servisi
  postgres:
    image: postgres:16
    container_name: sb-postgres
    environment:
      POSTGRES_DB: sb_scrapper
      POSTGRES_USER: sb_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: Europe/Istanbul
      PGTZ: Europe/Istanbul
    volumes:
      - ./pg-data:/var/lib/postgresql/data
      - ./pg-db/config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./pg-db/config/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./pg-db/config/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
    ports:
      - "${POSTGRES_PORT_EXTERNAL:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sb_user -d sb_scrapper && psql -U sb_user -d sb_scrapper -c 'SELECT 1' > /dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # PgBouncer Bağlantı Havuzu Servisi
  pgbouncer:
    build: ./pg-db/pgbouncer
    container_name: sb-pgbouncer
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${PGBOUNCER_PORT:-6432}:6432"
    environment:
      - POSTGRES_USER=sb_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=sb_scrapper
      - PGBOUNCER_POOL_MODE=${PGBOUNCER_POOL_MODE:-session}
      - PGBOUNCER_MAX_CLIENT_CONN=${PGBOUNCER_MAX_CLIENT_CONN:-150}
      - PGBOUNCER_DEFAULT_POOL_SIZE=${PGBOUNCER_DEFAULT_POOL_SIZE:-34}
    volumes:
      - ./pg-db/config/pgbouncer/pgbouncer.ini.template:/config/pgbouncer/pgbouncer.ini.template
      - ./pg-db/config/pgbouncer/userlist.txt.template:/config/pgbouncer/userlist.txt.template
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 6432 -U sb_user -d sb_scrapper"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Otomatik Yedekleme Servisi
  backup:
    image: postgres:16
    container_name: sb-backup
    restart: always
    env_file: .env
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backups:/backups
      - ./pg-db/backup/backup.sh:/usr/local/bin/backup.sh
    command: ["sh", "/usr/local/bin/backup.sh"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default

  sb-scraper:
    build: .
    init: true
    container_name: sb-scraper
    ports:
      - "${PORT:-8000}:8000"
    # Container kaynak ayarları - Chrome renderer crash'ını önlemek için
    shm_size: 2gb  # Shared memory boyutu (Chrome için gerekli)
    mem_limit: 4g  # Memory limit
    memswap_limit: 4g  # Memory + swap limit
    cpus: '2'  # CPU limit
    environment:
      # Tarayıcı Ayarları
      - TZ=Europe/Istanbul
      - HEADLESS=${HEADLESS:-true}
      - WAIT_TIME=${WAIT_TIME:-8}
      - USER_AGENT_PLATFORM=${USER_AGENT_PLATFORM:-windows}
      - PAGE_LOAD_TIMEOUT=${PAGE_LOAD_TIMEOUT:-60}
      - BODY_CHECK_WAIT_TIME=${BODY_CHECK_WAIT_TIME:-2}
      - PAGE_RELOAD_WAIT_TIME=${PAGE_RELOAD_WAIT_TIME:-5}
      - MOBILE_WAIT_TIME=${MOBILE_WAIT_TIME:-2}
      - SEARCH_ENGINE_WAIT_TIME=${SEARCH_ENGINE_WAIT_TIME:-3}
      - FRAME_SWITCH_WAIT_TIME=${FRAME_SWITCH_WAIT_TIME:-1}
      - CONSENT_CLICK_WAIT_TIME=${CONSENT_CLICK_WAIT_TIME:-3}
      
      # API Ayarları
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-8000}
      
      # Loglama Ayarları
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CONSOLE_LOGGING_ENABLED=${CONSOLE_LOGGING_ENABLED:-true}
      - POSTGRES_LOGGING_ENABLED=${POSTGRES_LOGGING_ENABLED:-true}
      - STRUCTURED_LOGGING_ENABLED=${STRUCTURED_LOGGING_ENABLED:-false}
      - GUNICORN_LOGGING_ENABLED=${GUNICORN_LOGGING_ENABLED:-true}
      - LOG_FORMAT=${LOG_FORMAT:-%(asctime)s | %(levelname)s | %(name)s:%(funcName)s:%(lineno)d - %(message)s}
      
      # Canvas Noise Ayarları
      - NOISE_MIN_VALUE=${NOISE_MIN_VALUE:--20}
      - NOISE_MAX_VALUE=${NOISE_MAX_VALUE:-20}
      
      # Black-List Ayarları
      - BLACKLIST_FILE=${BLACKLIST_FILE:-black-list.lst}
      
      # PostgreSQL Ayarları (PgBouncer üzerinden bağlantı)
      - POSTGRES_HOST=${POSTGRES_HOST:-pgbouncer}
      - POSTGRES_PORT=${POSTGRES_PORT:-6432}
      - POSTGRES_DB=${POSTGRES_DB:-sb_scrapper}
      - POSTGRES_USER=${POSTGRES_USER:-sb_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # Request Logging Ayarları
      - LOG_REQUEST_BODY=${LOG_REQUEST_BODY:-true}
      - LOG_REQUEST_HEADERS=${LOG_REQUEST_HEADERS:-true}
      - LOG_REQUEST_QUERY=${LOG_REQUEST_QUERY:-true}
      - MAX_REQUEST_BODY_SIZE=${MAX_REQUEST_BODY_SIZE:-10240}
      
      # Sensitive Headers (filtrelenecek header'lar)
      - SENSITIVE_HEADERS=${SENSITIVE_HEADERS:-["authorization","cookie","x-api-key","x-auth-token","api-key","token"]}
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pg-data:
  backups:
