# =================================================================================
# Örnek Performans Odaklı PostgreSQL 15+ Konfigürasyonu
# DONANIM: XX GB RAM, XX Çekirdek CPU, SATA Disk
# İŞ YÜKÜ: Karma (Yoğun Yazma ve Analitik Sorgular)
# =================================================================================

# ---------------------------------------------------------------------------------
# BAĞLANTI VE AĞ AYARLARI
# ---------------------------------------------------------------------------------

# Docker ve dış bağlantılar için tüm IP adreslerini dinle.
listen_addresses = '*'

# Mikroservis mimarisinde çok sayıda worker olacağı için bağlantı sayısını artıralım.
# NOT: Her bağlantı RAM kullanır. Connection Pooler (örn: PgBouncer) kullanmıyorsanız
# bu değeri dikkatli artırın. 200 iyi bir başlangıçtır.
max_connections = 200

# ---------------------------------------------------------------------------------
# BELLEK (RAM) YÖNETİMİ - EN KRİTİK AYARLAR
# ---------------------------------------------------------------------------------

# PostgreSQL'in veri bloklarını ve indexleri cache'lemek (önbelleğe almak) için
# kullanacağı RAM miktarı. Performans için en önemli ayardır.
# KURAL: Toplam sistem RAM'inin %25'i olarak ayarlanır.
# 16 GB RAM için -> 4 GB
shared_buffers = 4GB

# Sorgu planlayıcısına, PostgreSQL'in kendi cache'i (shared_buffers) ve işletim
# sisteminin dosya sistemi cache'i için ne kadar RAM'in uygun olduğunu söyler.
# Planlayıcının daha iyi kararlar vermesini (örn: index kullanıp kullanmamak) sağlar.
# KURAL: Toplam sistem RAM'inin %50 ila %75'i arası.
# 16 GB RAM için -> 12 GB
effective_cache_size = 12GB

# Sıralama (ORDER BY), birleştirme (JOIN), hashleme gibi işlemlerin her biri için
# ayrılabilecek maksimum RAM miktarı. Bu limit aşılırsa, işlem diske yazmaya başlar
# ve ÇOK yavaşlar. Analitik sorgularınız için bu değeri artırmak önemlidir.
# DİKKAT: Bu değer, anlık çalışan işlem sayısıyla çarpılır. Çok yükseltmek tehlikelidir.
# Varsayılan 4MB yerine 32MB iyi bir başlangıçtır.
work_mem = 32MB

# VACUUM, CREATE INDEX, ALTER TABLE gibi bakım işlemleri için ayrılan RAM miktarı.
# Bu değeri yüksek tutmak, özellikle yeni index oluşturma gibi işlemleri
# ciddi anlamda hızlandırır.
# 16 GB RAM için -> 1 GB
maintenance_work_mem = 1GB

# ---------------------------------------------------------------------------------
# YAZMA PERFORMANSI VE CHECKPOINT AYARLARI
# ---------------------------------------------------------------------------------
# Bu ayarlar, yazma performansını artırmak ve I/O (disk) üzerindeki stresi azaltmak içindir.

# WAL (Write-Ahead Log) verileri için RAM'de tutulan buffer boyutu.
# 16MB genellikle çoğu sistem için yeterli ve en verimli değerdir.
wal_buffers = 16MB

# Checkpoint'lerin ne sıklıkla olacağını belirler. Yoğun yazma olan sistemlerde
# bu değerleri artırmak, sürekli küçük I/O işlemleri yerine daha seyrek ama
# daha büyük I/O işlemleri yapılmasını sağlar, bu da performansı artırır.
min_wal_size = 1GB
max_wal_size = 4GB

# Bir checkpoint başladığında, bir sonraki checkpoint'e kadar olan sürenin %90'ına
# yayarak I/O işlemlerini yapsın. Bu, ani disk I/O yüklenmelerini engeller ve
# sistemin genel performansını daha stabil hale getirir.
checkpoint_completion_target = 0.9

# Verilerin diske güvenli bir şekilde yazılmasını sağlar. Performans için 'on'
# en iyi seçenektir, ancak çok eski disklerde 'off' düşünülebilir. Modern sistemlerde
# kesinlikle 'on' olmalıdır.
wal_writer_delay = 200ms
commit_delay = 0
commit_siblings = 5

# ---------------------------------------------------------------------------------
# SORGULAMA VE PLANLAYICI AYARLARI
# ---------------------------------------------------------------------------------

# SSD diskler için en önemli ayarlardan biridir. SSD'lerde rastgele erişim maliyeti
# sıralı erişim maliyetine çok yakındır. Bu değeri düşürmek, sorgu planlayıcısının
# Index Scan'leri (rastgele erişim) daha çok tercih etmesini sağlar.
# Spinning diskler için 4.0, SSD için 1.1 idealdir.
random_page_cost = 1.1

# Planlayıcının kullanabileceği varsayılan istatistik miktarını artırır.
# Daha iyi sorgu planları oluşturmasına yardımcı olur.
default_statistics_target = 100

# ---------------------------------------------------------------------------------
# PARALELİZM (WORKER PROCESSES)
# ---------------------------------------------------------------------------------
# PostgreSQL'in tek bir sorgu için birden fazla CPU çekirdeğini kullanmasını sağlar.

# Arka plan işlemleri için toplam worker sayısı. Genellikle CPU çekirdek sayısına eşitlenir.
# 8 Çekirdek CPU için -> 8
max_worker_processes = 16

# Tek bir sorgu grubunun kullanabileceği maksimum paralel worker sayısı.
# 8 Çekirdek CPU için -> 4
max_parallel_workers_per_gather = 8

# Sistemdeki tüm işlemlerin aynı anda kullanabileceği toplam paralel worker sayısı.
# Genellikle CPU çekirdek sayısına eşitlenir.
# 8 Çekirdek CPU için -> 8
max_parallel_workers = 16


# ---------------------------------------------------------------------------------
# PERFORMANS ANALİZİ İÇİN LOGLAMA AYARLARI
# ---------------------------------------------------------------------------------
# Bu ayarlar, yavaş çalışan sorguları tespit etmenize yardımcı olur.

# Docker ortamında logların `docker logs <container_name>` komutuyla görülebilmesi için.
log_destination = 'stderr'
logging_collector = on

# 500 milisaniyeden (yarım saniye) daha uzun süren tüm sorguları logla.
# Sisteminizdeki yavaş sorguları ve darboğazları bulmak için hayati önem taşır.
log_min_duration_statement = 500ms

# Checkpoint işlemlerini logla. I/O performans sorunlarını teşhis etmek için faydalıdır.
log_checkpoints = on

# Log satırlarının başına zaman damgası, kullanıcı, veritabanı gibi bilgileri ekler.
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '